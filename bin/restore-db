#!/bin/bash

# Restore Database from Backup
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./bin/restore-db <backup-file>

if [ -z "$1" ]; then
    echo "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª backup"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  ./bin/restore-db backups/db/industrialprofi_2026-02-08_10-30-00.sql"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ backups:"
    ls -lh backups/db/*.sql 2>/dev/null | awk '{print "  " $9 " (" $5 ")"}'
    exit 1
fi

BACKUP_FILE=$1

if [ ! -f "$BACKUP_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_FILE"
    exit 1
fi

echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!"
echo "   Backup: $BACKUP_FILE"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "–û—Ç–º–µ–Ω–µ–Ω–æ."
    exit 0
fi

echo ""
echo "üóÑÔ∏è  –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é –±–∞–∑—É
echo "1. –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –±–∞–∑—ã..."
docker-compose exec -T postgres psql -U postgres -c "DROP DATABASE IF EXISTS industrialprofi_development;"

# –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
echo "2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã..."
docker-compose exec -T postgres psql -U postgres -c "CREATE DATABASE industrialprofi_development;"

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ backup
echo "3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup..."
docker-compose exec -T postgres psql -U postgres industrialprofi_development < "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "üí° –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:"
    echo "   rails db:migrate"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏!"
    exit 1
fi
