#!/bin/bash

# Database Backup Script
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./bin/backup-db

BACKUP_DIR="./backups/db"
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_FILE="$BACKUP_DIR/industrialprofi_$TIMESTAMP.sql"

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

echo "üóÑÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "   –§–∞–π–ª: $BACKUP_FILE"

# –°–æ–∑–¥–∞—ë–º –¥–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker-compose exec -T postgres pg_dump -U postgres industrialprofi_development > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    
    echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo "   –†–∞–∑–º–µ—Ä: $SIZE"
    echo "   –ü—É—Ç—å: $BACKUP_FILE"
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤
    echo "üìã –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ backups:"
    ls -lh "$BACKUP_DIR"/*.sql 2>/dev/null | awk '{print "   " $9 " (" $5 ")"}'
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
    echo ""
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö backups (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)..."
    ls -t "$BACKUP_DIR"/*.sql 2>/dev/null | tail -n +11 | xargs -r rm
    
    echo ""
    echo "üí° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup:"
    echo "   docker-compose exec -T postgres psql -U postgres industrialprofi_development < $BACKUP_FILE"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ backup!"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω–∞: docker-compose ps"
    exit 1
fi
